#!/usr/bin/env bash
set -euo pipefail

# Rofi picker to bring a selected window to the current workspace,
# placing it as a new column immediately to the right of the
# currently focused column. Use --focus-only to jump instead.

focus_only=0
if [[ "${1:-}" == "--focus-only" ]]; then
  focus_only=1
fi

orig_ws_idx=$(niri msg -j workspaces | jq -r '.[] | select(.is_focused) | .idx')
orig_ws_id=$(niri msg -j workspaces | jq -r '.[] | select(.is_focused) | .id')
orig_col_idx=$(niri msg -j focused-window | jq -r '.layout.pos_in_scrolling_layout[0] // empty')

windows_json=$(niri msg -j windows)

list=$(printf '%s' "$windows_json" | jq -r '
  sort_by(.workspace_id, .app_id, .title) | .[] |
  "\(.app_id) â€¢ \(.title // "(no title)")  [ws=\(.workspace_id)]  #id=\(.id)"')

[[ -z "$list" ]] && exit 0

choice=$(printf '%s\n' "$list" | rofi -dmenu -i -p "Bring here:")
[[ -z "$choice" ]] && exit 0

sel_id=$(sed -n 's/.*#id=\([0-9]\+\).*/\1/p' <<<"$choice")
[[ -z "$sel_id" ]] && exit 1

if [[ "$focus_only" == "1" ]]; then
  niri msg action focus-window --id "$sel_id"
  exit 0
fi

on_current=$(printf '%s' "$windows_json" \
  | jq -r --argjson id "$sel_id" --argjson cur "$orig_ws_id" \
      'any(.[]; .id == $id and .workspace_id == $cur)')

if [[ "$on_current" == "true" ]]; then
  niri msg action focus-window --id "$sel_id"
  niri msg action expel-window-from-column
  if [[ -n "${orig_col_idx}" ]]; then
    niri msg action move-column-to-index "$((orig_col_idx + 1))"
  fi
  exit 0
fi

niri msg action move-window-to-workspace --window-id "$sel_id" --focus false "$orig_ws_idx"
niri msg action focus-window --id "$sel_id"
niri msg action expel-window-from-column
if [[ -n "${orig_col_idx}" ]]; then
  niri msg action move-column-to-index "$((orig_col_idx + 1))"
fi

